pipeline {
  agent any

  parameters {
    choice(name: 'ACTION', choices: ['plan', 'apply', 'destroy'], description: 'Terraform action')
    booleanParam(name: 'BUILD_AMIS', defaultValue: false, description: 'Build base AMI with Packer')
  }

  environment {
    AWS_ACCESS_KEY_ID      = credentials('aws-access-key-id')
    AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
    AWS_REGION            = 'us-east-2'
    AWS_SSH_KEY           = credentials('AWS_SSH_KEY')

    TF_VAR_db_username    = credentials('db_username')
    TF_VAR_db_password    = credentials('db_password')
    TF_VAR_db_name        = credentials('db_name')
    TF_VAR_key_name       = credentials('key_name')
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build Base AMI') {
      when { expression { params.BUILD_AMIS } }
      steps {
        dir('packer') {
          sh '''
            packer init .
            packer build web-app-base.pkr.hcl
          '''
        }
      }
    }

    stage('Terraform') {
      steps {
        dir('terraform') {
          sh 'terraform init'

          script {
            if (params.ACTION == 'plan') {
              sh 'terraform plan -input=false'
            }

            if (params.ACTION == 'apply') {
              sh 'terraform apply -auto-approve -input=false'
            }

            if (params.ACTION == 'destroy') {
              input message: 'Are you sure you want to destroy?', ok: 'Destroy'
              sh 'terraform destroy -auto-approve -input=false'
            }
          }
        }
      }
    }

    stage('Get IPs') {
      when { expression { params.ACTION == 'apply' } }
      steps {
        dir('terraform') {
          script {
            env.BACKEND_IP = sh(
              script: "terraform output -json backend_private_ips | jq -r '.[0]'",
              returnStdout: true
            ).trim()

            env.WEB_IPS = sh(
              script: "terraform output -json web_server_ips",
              returnStdout: true
            ).trim()

            echo "Backend IP: ${env.BACKEND_IP}"
            echo "Web IPs: ${env.WEB_IPS}"
          }
        }
      }
    }

    stage('Deploy Nginx + Reverse Proxy') {
    when { expression { params.ACTION == 'apply' } }
      steps {
        script {
        sshagent(credentials: ['AWS_SSH_KEY']) {
          sh """
          for ip in \$(echo "$WEB_IPS" | jq -r '.[]'); do
          echo "Configuring Nginx on \$ip"

          ssh -o StrictHostKeyChecking=no ec2-user@\${ip} << EOF
          rm -rf /tmp/fruits
          git clone https://github.com/ajanakueniola-commits/fruits-veg_market.git /tmp/fruits
          cd /tmp/fruits/frontend

          sed -i "s|http://localhost|http://${BACKEND_IP}|g" index.html
          sudo cp index.html /usr/share/nginx/html/index.html

          sudo tee /etc/nginx/conf.d/app.conf > /dev/null << EOL
      server {
        listen 80;
          server_name enny4life.duckdns.org;

      location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files \\\$uri \\\$uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://${BACKEND_IP}:8000/;
        proxy_set_header Host \\\$host;
        proxy_set_header X-Real-IP \\\$remote_addr;
    }
}
EOL

          sudo nginx -t
          sudo systemctl restart nginx
EOF
      done
      """
    }
  }
}


  post {
    success {
      echo 'Deployment successful ðŸš€'
    }
    failure {
      echo 'Pipeline failed âŒ'
    }
  }
}
  }
}

