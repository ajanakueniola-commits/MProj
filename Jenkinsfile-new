pipeline {
    agent any

    parameters {
        booleanParam(name: 'BUILD_AMIS', defaultValue: false, description: 'Build AMI?')
        choice(name: 'ACTION', choices: ['plan', 'apply', 'destroy'], description: 'Terraform Action')
    }

    environment {
        AWS_ACCESS_KEY_ID      = credentials('aws-access-key-id')
        AWS_SECRET_ACCESS_KEY  = credentials('aws-secret-access-key')
        AWS_REGION             = 'us-east-2'
        AWS_SSH_KEY            = credentials('AWS_SSH_KEY')

        TF_VAR_db_username     = credentials('db_username')
        TF_VAR_db_password     = credentials('db_password')
        TF_VAR_db_name         = credentials('db_name')
        TF_VAR_key_name        = credentials('key_name')
    }

    stages {

        stage('Checkout Code') {
            steps {
                checkout([$class: 'GitSCM', branches: [[name: 'refs/heads/mini-project']],
                          userRemoteConfigs: [[url: 'https://github.com/ajanakueniola-commits/MProj.git']]])
            }
        }

        stage('Build Base AMI') {
            when { expression { params.BUILD_AMIS } }
            steps {
                dir('packer') {
                    sh '''
                        packer init .
                        packer build web-app-base.pkr.hcl
                    '''
                }
            }
        }

        stage('Terraform') {
            steps {
                dir('terraform') {
                    // Configure Terraform backend with S3
                    sh """
                        cat > backend.tf <<EOL
                        terraform {
                          backend "s3" {
                            bucket = "funmi-cicd-state-bucket"
                            key    = "terraform/state.tfstate"
                            region = "${AWS_REGION}"
                          }
                        }
                        EOL
                    """

                    sh 'terraform init'

                    script {
                        if (params.ACTION == 'plan') {
                            sh 'terraform plan -input=false'
                        }
                        if (params.ACTION == 'apply') {
                            sh 'terraform apply -auto-approve -input=false'
                        }
                        if (params.ACTION == 'destroy') {
                            input message: 'Are you sure you want to destroy?', ok: 'Destroy'
                            sh 'terraform destroy -auto-approve -input=false'
                        }
                    }
                }
            }
        }

        stage('Fetch Terraform Outputs') {
            steps {
                dir('terraform') {
                    script {
                        // Fetch backend private IPs
                        env.BACKEND_IPS = sh(script: "terraform output -json backend_private_ips | jq -r '.[]'", returnStdout: true).trim()
                        echo "Backend IPs: ${env.BACKEND_IPS}"

                        // Fetch web server IPs
                        env.WEB_IPS = sh(script: "terraform output -json web_server_ips | jq -r '.[]'", returnStdout: true).trim()
                        echo "Web Server IPs: ${env.WEB_IPS}"
                    }
                }
            }
        }

        stage('Deploy Backend App') {
            steps {
                script {
                    sh """
                        rm -rf /opt/backend
                        git clone -b mini-project https://github.com/ajanakueniola-commits/fruits-veg_market.git /opt/backend
                        cd /opt/backend/backend

                        for ip in ${env.BACKEND_IPS}; do
                            echo "Deploying backend to \$ip"

                            # Copy app files
                            scp -i \$AWS_SSH_KEY -r ./* ec2-user@\$ip:/home/ec2-user/backend/

                            # Restart backend service
                            ssh -i \$AWS_SSH_KEY ec2-user@\$ip 'sudo systemctl restart backend.service'
                        done
                    """
                }
            }
        }

        stage('Deploy Web + Nginx') {
            steps {
                script {
                    sh """
                        rm -rf /opt/web
                        git clone -b mini-project https://github.com/ajanakueniola-commits/fruits-veg_market.git /opt/web
                        cd /opt/web/frontend

                        for ip in ${env.WEB_IPS}; do
                            echo "Deploying web app + nginx to \$ip"

                            # Copy web files
                            scp -i \$AWS_SSH_KEY -r ./* ec2-user@\$ip:/var/www/html/

                            # Copy Nginx config with reverse proxy to web server
                            echo "server {
                                listen 80;
                                server_name enny4life.duckdns.org;

                                location / {
                                    proxy_pass http://\$ip;
                                    proxy_set_header Host \$host;
                                    proxy_set_header X-Real-IP \$remote_addr;
                                }
                            }" | ssh -i \$AWS_SSH_KEY ec2-user@\$ip 'sudo tee /etc/nginx/conf.d/reverse-proxy.conf'

                            # Restart nginx
                            ssh -i \$AWS_SSH_KEY ec2-user@\$ip 'sudo systemctl restart nginx'
                        done
                    """
                }
            }
        }
    }

    post {
        success {
            echo "Web & App deployment succeeded âœ…"
        }
        failure {
            echo "Web & App deployment failed âŒ"
        }
    }
}
