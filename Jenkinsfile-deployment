pipeline {
  agent any

  environment {
    AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
    AWS_ACCESS_KEY_ID     = credentials('aws-access-key-id')
    AWS_REGION            = 'us-east-2'
    AWS_SSH_KEY           = credentials('AWS_SSH_KEY')
  }

  parameters {
    booleanParam(
      name: 'DEPLOY_APP',
      defaultValue: false,
      description: 'Deploy backend application'
    )

    booleanParam(
      name: 'DEPLOY_WEB',
      defaultValue: false,
      description: 'Deploy web frontend and Nginx reverse proxy'
    )
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Fetch Terraform Outputs') {
      steps {
        script {
          dir('terraform') {
            env.BACKEND_IP = sh(
              script: "terraform output -json backend_private_ips | jq -r '.[0]'",
              returnStdout: true
            ).trim()

            env.WEB_IPS = sh(
              script: "terraform output -json web_server_ips",
              returnStdout: true
            ).trim()
          }

          echo "Backend Private IP: ${env.BACKEND_IP}"
          echo "Web Server IPs: ${env.WEB_IPS}"
        }
      }
    }

    /* =====================================================
       BACKEND APPLICATION DEPLOYMENT
       ===================================================== */

    stage('Deploy Backend App') {
      when { expression { params.DEPLOY_APP } }
      steps {
        sshagent(credentials: ['AWS_SSH_KEY']) {
          sh """
          echo "Deploying backend application..."

          ssh -o StrictHostKeyChecking=no ec2-user@${env.BACKEND_IP} << 'EOF'
            set -e

            sudo yum install -y git python3
            sudo pip3 install --upgrade pip

            rm -rf /opt/backend
            git clone https://github.com/ajanakueniola-commits/fruits-veg_market.git /opt/backend
            cd /opt/backend/backend

            pip3 install -r requirements.txt

            sudo tee /etc/systemd/system/backend.service > /dev/null << EOL
[Unit]
Description=Fruits Backend API
After=network.target

[Service]
User=ec2-user
WorkingDirectory=/opt/backend/backend
ExecStart=/usr/bin/python3 app.py
Restart=always
Environment=PYTHONUNBUFFERED=1

[Install]
WantedBy=multi-user.target
EOL

            sudo systemctl daemon-reexec
            sudo systemctl daemon-reload
            sudo systemctl enable backend
            sudo systemctl restart backend

            sudo systemctl status backend --no-pager
EOF
          """
        }
      }
    }

    /* =====================================================
       WEB + NGINX REVERSE PROXY DEPLOYMENT
       ===================================================== */

    stage('Deploy Web + Nginx') {
      when { expression { params.DEPLOY_WEB } }
      steps {
        sshagent(credentials: ['AWS_SSH_KEY']) {
          sh """
          for ip in \$(echo '${env.WEB_IPS}' | jq -r '.[]'); do
            echo "Deploying web frontend on \$ip"

            ssh -o StrictHostKeyChecking=no ec2-user@\${ip} << 'EOF'
              set -e

              sudo yum install -y git nginx
              sudo systemctl enable nginx

              rm -rf /opt/frontend
              git clone https://github.com/ajanakueniola-commits/fruits-veg_market.git /opt/frontend
              cd /opt/frontend/frontend

              sed -i 's|http://localhost|http://${env.BACKEND_IP}:8000|g' index.html
              sudo cp index.html /usr/share/nginx/html/index.html

              sudo tee /etc/nginx/conf.d/app.conf > /dev/null << EOL
server {
    listen 80;
    server_name enny4life.duckdns.org;

    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files \\$uri \\$uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://${env.BACKEND_IP}:8000/;
        proxy_http_version 1.1;
        proxy_set_header Host \\$host;
        proxy_set_header X-Real-IP \\$remote_addr;
        proxy_set_header X-Forwarded-For \\$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \\$scheme;
    }
}
EOL

              sudo nginx -t
              sudo systemctl restart nginx
              sudo systemctl status nginx --no-pager
EOF
          done
          """
        }
      }
    }
  }

  post {
    success {
      echo 'Web & App deployment successful ðŸš€'
    }
    failure {
      echo 'Web & App deployment failed âŒ'
    }
  }
}
