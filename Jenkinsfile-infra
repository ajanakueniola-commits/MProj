pipeline {
  agent any

  environment {
    AWS_ACCESS_KEY_ID      = credentials('aws-access-key-id')
    AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
    AWS_REGION            = 'us-east-2'
    AWS_SSH_KEY           = credentials('AWS_SSH_KEY')

    TF_VAR_db_username    = credentials('db_username')
    TF_VAR_db_password    = credentials('db_password')
    TF_VAR_db_name        = credentials('db_name')
    TF_VAR_key_name       = credentials('key_name')
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build Base AMI') {
      when { expression { params.BUILD_AMIS } }
      steps {
        dir('packer') {
          sh '''
            packer init .
            packer build web-app-base.pkr.hcl
          '''
        }
      }
    }

    stage('Terraform') {
      steps {
        dir('terraform') {
          sh 'terraform init'

          script {
            if (params.ACTION == 'plan') {
              sh 'terraform plan -input=false'
            }

            if (params.ACTION == 'apply') {
              sh 'terraform apply -auto-approve -input=false'
            }

            if (params.ACTION == 'destroy') {
              input message: 'Are you sure you want to destroy?', ok: 'Destroy'
              sh 'terraform destroy -auto-approve -input=false'
            }
          }
        }
      }
    }